{"version":3,"sources":["webpack:///./src/views/Comments.vue?dd18","webpack:///./src/factories/SocketMessenger.js","webpack:///./src/factories/SocketMessage.js","webpack:///src/views/Comments.vue","webpack:///./src/views/Comments.vue?2666","webpack:///./src/views/Comments.vue"],"names":["render","_vm","this","_h","$createElement","_c","_self","directives","name","rawName","value","expression","attrs","domProps","on","$event","type","indexOf","_k","keyCode","key","addComment","target","composing","comment","_v","_l","id","_s","text","removeComment","staticRenderFns","SocketMessenger","url","pool","timeouts","WSObj","connected","WebSocket","onopen","onOpen","bind","onclose","onClose","onerror","onError","onmessage","onMessage","e","console","log","index","findIndex","v","message","data","TMID","clearTimeout","splice","m","onSuccess","timeout","t","messageId","timeoutId","wasClean","socketMessageObject","send","setTimeout","removeFromPoolById","push","error","socketMessageId","close","SocketMessage","Math","round","Date","now","random","comments","socketMessenger","connect","disconnect","methods","sendMessage","response","String","component"],"mappings":"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","file":"js/Comments.7d616ee5.js","sourcesContent":["var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',[_c('input',{directives:[{name:\"model\",rawName:\"v-model\",value:(_vm.comment),expression:\"comment\"}],attrs:{\"type\":\"text\"},domProps:{\"value\":(_vm.comment)},on:{\"keypress\":function($event){if(!$event.type.indexOf('key')&&_vm._k($event.keyCode,\"enter\",13,$event.key,\"Enter\")){ return null; }return _vm.addComment($event)},\"input\":function($event){if($event.target.composing){ return; }_vm.comment=$event.target.value}}}),_c('button',{on:{\"click\":_vm.addComment}},[_vm._v(\"Добавить комментарий\")]),_c('ul',_vm._l((_vm.comments),function(comment){return _c('li',{key:comment.id},[_c('span',[_vm._v(_vm._s(comment.text))]),_c('span',[_c('button',{on:{\"click\":function($event){return _vm.removeComment(comment.id)}}},[_vm._v(\"удалить\")])])])}),0)])}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","export class SocketMessenger {\n  constructor(url) {\n    this.pool = [];\n    this.timeouts = [];\n    this.url = url;\n    this.WSObj = null;\n    this.connected = false;\n  }\n\n  connect() {\n    this.WSObj = new WebSocket(this.url);\n    this.WSObj.onopen = this.onOpen.bind(this);\n    this.WSObj.onclose = this.onClose.bind(this);\n    this.WSObj.onerror = this.onError.bind(this);\n    this.WSObj.onmessage = this.onMessage.bind(this);\n  }\n\n  onError(e) {\n    console.log(\"Error:\", e);\n    const index = this.pool.findIndex(v => v.message === e.data);\n    if (index > -1) {\n      this.pool[index].onError(e);\n      const TMID = this.pool[index].TMID;\n      if (TMID !== null) clearTimeout(TMID);\n      this.pool.splice(index, 1);\n    }\n  }\n\n  onMessage(m) {\n    console.log(\"Message:\", m);\n    const index = this.pool.findIndex(v => v.message === m.data);\n    if (index > -1) {\n      const message = this.pool[index];\n      message.onSuccess(m);\n      if (message.timeout) {\n        const index = this.timeouts.findIndex(\n          t => t.messageId === message.messageId\n        );\n        if (index > -1) {\n          clearTimeout(this.timeouts[index].timeoutId);\n          this.timeouts.splice(index, 1);\n        }\n      }\n      this.pool.splice(index, 1);\n    }\n  }\n\n  onOpen() {\n    console.log(\"Connected\");\n    this.connected = true;\n  }\n\n  onClose(e) {\n    if (e.wasClean) {\n      console.log(\"Closed\");\n    } else {\n      console.log(\"Broken\");\n    }\n    this.connected = false;\n  }\n\n  sendMessage(socketMessageObject) {\n    if (!this.connected) {\n      console.error(\"Socket not connected\");\n      return;\n    }\n    this.WSObj.send(socketMessageObject.message);\n    if (socketMessageObject.timeout) {\n      const timeoutId = setTimeout(() => {\n        this.removeFromPoolById(socketMessageObject.messageId);\n        console.log(\"TIMEOUTED\", socketMessageObject.message);\n      }, socketMessageObject.timeout);\n      this.timeouts.push({\n        messageId: socketMessageObject.messageId,\n        timeoutId\n      });\n    }\n    this.pool.push(socketMessageObject);\n  }\n\n  removeFromPoolById(socketMessageId) {\n    const index = this.pool.findIndex(v => v.messageId === socketMessageId);\n    if (index) this.pool.splice(index, 1);\n  }\n\n  disconnect() {\n    this.WSObj.close();\n  }\n}\n","export class SocketMessage {\n  constructor({ message = \"\", onSuccess, onError, timeout = 0 } = {}) {\n    this.messageId = Math.round(Date.now() * Math.random());\n    this.message = message;\n    this.onSuccess = typeof onSuccess === \"function\" ? onSuccess : () => {};\n    this.onError = typeof onError === \"function\" ? onError : () => {};\n    this.timeout = timeout;\n  }\n}\n","<template>\n  <div>\n    <input type=\"text\" v-model=\"comment\" @keypress.enter=\"addComment\" />\n    <button @click=\"addComment\">Добавить комментарий</button>\n    <ul>\n      <li v-for=\"comment in comments\" :key=\"comment.id\">\n        <span>{{ comment.text }}</span>\n        <span>\n          <button @click=\"removeComment(comment.id)\">удалить</button>\n        </span>\n      </li>\n    </ul>\n  </div>\n</template>\n\n<script>\nimport { SocketMessenger } from \"../factories/SocketMessenger\";\nimport { SocketMessage } from \"../factories/SocketMessage\";\n\nexport default {\n  name: \"Comments\",\n  data() {\n    return {\n      comments: [\n        {\n          id: \"1\",\n          text: \"Тестовый коммент 1\"\n        },\n        {\n          id: \"2\",\n          text: \"Это шедевр\"\n        },\n        {\n          id: \"3\",\n          text: \"Это прекрасно\"\n        },\n        {\n          id: \"4\",\n          text: \"Лучшее, что я видел\"\n        },\n        {\n          id: \"5\",\n          text: \"Два чая этому автору\"\n        }\n      ],\n      comment: \"\",\n      socketMessenger: new SocketMessenger(\"wss://echo.websocket.org\")\n    };\n  },\n  mounted() {\n    this.socketMessenger.connect();\n  },\n  beforeDestroy() {\n    this.socketMessenger.disconnect();\n  },\n  methods: {\n    removeComment(id) {\n      this.socketMessenger.sendMessage(\n        new SocketMessage({\n          message: id,\n          onSuccess: response => {\n            const index = this.comments.findIndex(v => v.id === id);\n            if (index > -1) {\n              this.comments.splice(index, 1);\n            }\n            console.log(\"Removed:\", response.data);\n          },\n          onError: error => {\n            console.log(\"remove comment error:\", error);\n          },\n          timeout: 500\n        })\n      );\n    },\n    addComment() {\n      this.socketMessenger.sendMessage(\n        new SocketMessage({\n          message: this.comment,\n          onSuccess: response => {\n            this.comments.push({\n              id: String(Math.round(Math.random() * 10000)),\n              text: response.data\n            });\n            this.comment = \"\";\n          },\n          onError: error => {\n            console.log(\"add comment error:\", error);\n          }\n        })\n      );\n    }\n  }\n};\n</script>\n\n<style scoped></style>\n","import mod from \"-!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Comments.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Comments.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./Comments.vue?vue&type=template&id=458047ee&scoped=true&\"\nimport script from \"./Comments.vue?vue&type=script&lang=js&\"\nexport * from \"./Comments.vue?vue&type=script&lang=js&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"458047ee\",\n  null\n  \n)\n\nexport default component.exports"],"sourceRoot":""}